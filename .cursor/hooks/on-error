#!/bin/bash
# Cursor Hook: on-error
# 错误发生时触发

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CURSOR_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# 加载工具函数
source "${CURSOR_ROOT}/lib/hook_utils.sh"

# 初始化
init_log
log_info "========================================="
log_info "触发 Hook: on-error"
log_info "========================================="

# 获取错误信息
ERROR_TYPE="${1:-runtime}"  # syntax/runtime/build/test
ERROR_MESSAGE="$2"
ERROR_FILE="$3"
ERROR_LINE="$4"

log_info "错误类型: ${ERROR_TYPE}"
log_info "错误消息: ${ERROR_MESSAGE}"
log_info "错误文件: ${ERROR_FILE}"
log_info "错误行号: ${ERROR_LINE}"

# 根据错误类型确定事件类型
case "$ERROR_TYPE" in
    syntax)
        EVENT_TYPE="syntax_error"
        ;;
    runtime)
        EVENT_TYPE="runtime_error"
        ;;
    build)
        EVENT_TYPE="build_error"
        ;;
    test)
        EVENT_TYPE="test_fail"
        ;;
    *)
        EVENT_TYPE="error"
        ;;
esac

# 构建事件数据
EVENT_DATA=$(cat <<EOF
{
    "error_type": "${ERROR_TYPE}",
    "message": "$(json_escape "$ERROR_MESSAGE")",
    "file": "${ERROR_FILE}",
    "line": "${ERROR_LINE}"
}
EOF
)

log_debug "事件数据: ${EVENT_DATA}"

# 发送到オルテンシア
log_info "发送事件到オルテンシア..."

load_config

if [ -f "${VENV_PATH}/bin/activate" ]; then
    source "${VENV_PATH}/bin/activate"
    
    python "${CURSOR_ROOT}/lib/websocket_sender.py" \
        --event "${EVENT_TYPE}" \
        --message "${ERROR_MESSAGE}" \
        --data "${EVENT_DATA}" \
        2>> "${LOG_FILE}"
    
    SEND_RESULT=$?
    deactivate
    
    if [ $SEND_RESULT -eq 0 ]; then
        log_info "✅ on-error hook 执行成功"
    else
        log_error "❌ on-error hook 执行失败 (exit code: ${SEND_RESULT})"
    fi
else
    log_error "❌ Python 虚拟环境不存在: ${VENV_PATH}"
fi

log_info "========================================="
exit 0

