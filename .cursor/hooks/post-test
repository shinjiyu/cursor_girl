#!/bin/bash
# Cursor Hook: post-test
# 测试完成后触发

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CURSOR_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# 加载工具函数
source "${CURSOR_ROOT}/lib/hook_utils.sh"

# 初始化
init_log
log_info "========================================="
log_info "触发 Hook: post-test"
log_info "========================================="

# 获取测试结果
TEST_STATUS="${1:-pass}"  # pass/fail
TEST_PASSED="${2:-0}"
TEST_FAILED="${3:-0}"
TEST_TOTAL=$((TEST_PASSED + TEST_FAILED))
TEST_TIME="${4:-0}"

log_info "测试状态: ${TEST_STATUS}"
log_info "通过: ${TEST_PASSED}/${TEST_TOTAL}"
log_info "失败: ${TEST_FAILED}/${TEST_TOTAL}"
log_info "耗时: ${TEST_TIME}s"

# 根据测试结果确定事件类型
if [ "$TEST_STATUS" = "pass" ] && [ "$TEST_FAILED" -eq 0 ]; then
    EVENT_TYPE="test_pass"
else
    EVENT_TYPE="test_fail"
fi

# 构建事件数据
EVENT_DATA=$(cat <<EOF
{
    "status": "${TEST_STATUS}",
    "passed": ${TEST_PASSED},
    "failed": ${TEST_FAILED},
    "total": ${TEST_TOTAL},
    "duration": ${TEST_TIME}
}
EOF
)

log_debug "事件数据: ${EVENT_DATA}"

# 发送到オルテンシア
log_info "发送事件到オルテンシア..."

load_config

if [ -f "${VENV_PATH}/bin/activate" ]; then
    source "${VENV_PATH}/bin/activate"
    
    python "${CURSOR_ROOT}/lib/websocket_sender.py" \
        --event "${EVENT_TYPE}" \
        --data "${EVENT_DATA}" \
        2>> "${LOG_FILE}"
    
    SEND_RESULT=$?
    deactivate
    
    if [ $SEND_RESULT -eq 0 ]; then
        log_info "✅ post-test hook 执行成功"
    else
        log_error "❌ post-test hook 执行失败 (exit code: ${SEND_RESULT})"
        exit $SEND_RESULT
    fi
else
    log_error "❌ Python 虚拟环境不存在: ${VENV_PATH}"
    exit 1
fi

log_info "========================================="
exit 0

