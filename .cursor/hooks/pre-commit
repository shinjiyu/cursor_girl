#!/bin/bash
# Cursor Hook: pre-commit
# Git commit 前触发（用于验证、格式化等）

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CURSOR_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

# 加载工具函数
source "${CURSOR_ROOT}/lib/hook_utils.sh"

# 初始化
init_log
log_info "========================================="
log_info "触发 Hook: pre-commit"
log_info "========================================="

# 检查是否在 Git 仓库中
if ! is_git_repo; then
    log_error "错误: 不在 Git 仓库中"
    exit 1
fi

# 获取待提交的文件
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null | grep -v '^$')
if [ -z "$STAGED_FILES" ]; then
    FILES_COUNT=0
else
    FILES_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')
fi

log_info "待提交文件数: ${FILES_COUNT}"

# 如果没有文件，直接退出
if [ "$FILES_COUNT" -eq 0 ]; then
    log_info "没有待提交的文件"
    exit 0
fi

# 构建事件数据
EVENT_TYPE="pre_commit"
EVENT_DATA=$(cat <<EOF
{
    "files_count": ${FILES_COUNT},
    "files": $(echo "$STAGED_FILES" | head -5 | jq -R . | jq -s .)
}
EOF
)

log_debug "事件数据: ${EVENT_DATA}"

# 发送到オルテンシア
log_info "发送事件到オルテンシア..."

load_config

if [ -f "${VENV_PATH}/bin/activate" ]; then
    source "${VENV_PATH}/bin/activate"
    
    python "${CURSOR_ROOT}/lib/websocket_sender.py" \
        --event "${EVENT_TYPE}" \
        --data "${EVENT_DATA}" \
        2>> "${LOG_FILE}"
    
    SEND_RESULT=$?
    deactivate
    
    if [ $SEND_RESULT -eq 0 ]; then
        log_info "✅ pre-commit hook 执行成功"
    else
        log_error "❌ pre-commit hook 执行失败 (exit code: ${SEND_RESULT})"
        # pre-commit 失败不应该阻止提交
    fi
else
    log_error "❌ Python 虚拟环境不存在: ${VENV_PATH}"
fi

log_info "========================================="
exit 0

