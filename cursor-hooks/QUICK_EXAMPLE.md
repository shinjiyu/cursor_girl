# å¿«é€Ÿç¤ºä¾‹ï¼šAgent Hook â†’ Cursor Hook

## ğŸ¯ ä½ çš„åœºæ™¯

```
æ”¶åˆ° Agent Hook çš„ "complete" äº‹ä»¶
     â†“
 è®¤ä¸º Cursor ç©ºé—²äº†
     â†“
 æƒ³ç»™å®ƒå‘é€æ–°ä»»åŠ¡
     â†“
   å¦‚ä½•æ‰¾åˆ°å®ƒï¼Ÿ
```

---

## âœ… è§£å†³æ–¹æ¡ˆï¼ˆ3 æ­¥ï¼‰

### æ­¥éª¤ 1ï¼šCursor Hook æ³¨å†Œæ—¶

```
Cursor å¯åŠ¨ (PID: 12345)
    â”‚
    â”œâ”€â†’ ID: cursor-12345
    â”œâ”€â†’ Workspace: /Users/user/project
    â”‚
    â””â”€â†’ æœåŠ¡å™¨ä¿å­˜æ˜ å°„:
        workspace_to_cursor["/Users/user/project"] = "cursor-12345"
```

### æ­¥éª¤ 2ï¼šAgent Hook å‘é€ complete äº‹ä»¶

```json
{
  "from": "agent-hook-d42b-ed81",
  "payload": {
    "text": "å‘½ä»¤å®Œæˆï¼šgit status",
    "workspace": "/Users/user/project"  â† å…³é”®ï¼
  }
}
```

### æ­¥éª¤ 3ï¼šæœåŠ¡å™¨æŸ¥æ‰¾å¹¶å‘é€ä»»åŠ¡

```python
# æå– workspace
workspace = message.payload["workspace"]
# â†’ "/Users/user/project"

# æŸ¥æ‰¾å¯¹åº”çš„ Cursor ID
cursor_id = registry.get_cursor_by_workspace(workspace)
# â†’ "cursor-12345" âœ… æ‰¾åˆ°äº†ï¼

# å‘é€æ–°ä»»åŠ¡
cursor_client = registry.get_by_id(cursor_id)
command = MessageBuilder.agent_execute_prompt(
    from_id="server",
    to_id=cursor_id,
    prompt="æ–°ä»»åŠ¡"
)
await cursor_client.websocket.send(command.to_json())
```

---

## ğŸ“Š æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Cursor Hook æ³¨å†Œ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cursor-12345 â†’ workspace: /Users/user/project   â”‚
â”‚                                                  â”‚
â”‚ æœåŠ¡å™¨ç»´æŠ¤æ˜ å°„:                                   â”‚
â”‚ workspace_to_cursor = {                         â”‚
â”‚   "/Users/user/project": "cursor-12345"         â”‚
â”‚ }                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Agent Hook å‘é€ complete                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ agent-hook-d42b-ed81                            â”‚
â”‚ workspace: /Users/user/project                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æœåŠ¡å™¨æŸ¥æ‰¾                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ workspace: /Users/user/project                  â”‚
â”‚     â†“                                           â”‚
â”‚ æŸ¥è¯¢ workspace_to_cursor                        â”‚
â”‚     â†“                                           â”‚
â”‚ æ‰¾åˆ°: cursor-12345 âœ…                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‘é€æ–°ä»»åŠ¡                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ to: cursor-12345                                â”‚
â”‚ command: agent_execute_prompt                   â”‚
â”‚ prompt: "æ–°ä»»åŠ¡"                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æœåŠ¡å™¨ç«¯ä»£ç ï¼ˆå¤åˆ¶å³ç”¨ï¼‰

```python
async def handle_agent_complete_event(message: Message):
    """å¤„ç† Agent Hook çš„ complete äº‹ä»¶"""
    
    # 1. è·å– workspace
    workspace = message.payload.get('workspace')
    
    if not workspace:
        logger.warning("æ¶ˆæ¯ç¼ºå°‘ workspace å­—æ®µ")
        return
    
    # 2. æŸ¥æ‰¾å¯¹åº”çš„ Cursor
    cursor_id = registry.get_cursor_by_workspace(workspace)
    
    if not cursor_id:
        logger.warning(f"æœªæ‰¾åˆ° workspace å¯¹åº”çš„ Cursor: {workspace}")
        return
    
    cursor_client = registry.get_by_id(cursor_id)
    
    if not cursor_client:
        logger.warning(f"Cursor å·²æ–­å¼€: {cursor_id}")
        return
    
    # 3. å‘é€æ–°ä»»åŠ¡
    command = MessageBuilder.agent_execute_prompt(
        from_id="server",
        to_id=cursor_id,
        agent_id="default",
        prompt="è¯·åˆ†æå½“å‰é¡¹ç›®çš„ä»£ç ç»“æ„"
    )
    
    await cursor_client.websocket.send(command.to_json())
    
    logger.info(f"âœ… ä»»åŠ¡å·²å‘é€åˆ° {cursor_id}")
```

---

## âœ¨ å…³é”®ç‚¹

1. **ä¸éœ€è¦åŒ¹é… ID**
   - Agent Hook çš„ `agent-hook-xxx` å’Œ Cursor Hook çš„ `cursor-12345` ä¸éœ€è¦åŒ¹é…
   - é€šè¿‡ workspace å­—æ®µå…³è”

2. **è‡ªåŠ¨ç»´æŠ¤**
   - Cursor æ³¨å†Œæ—¶ï¼šè‡ªåŠ¨ä¿å­˜ workspace æ˜ å°„
   - Cursor æ–­å¼€æ—¶ï¼šè‡ªåŠ¨æ¸…ç†æ˜ å°„

3. **ç®€å•å¯é **
   - ä¸€è¡Œä»£ç æŸ¥æ‰¾ï¼š`registry.get_cursor_by_workspace(workspace)`
   - 100% å‡†ç¡®åŒ¹é…

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- `WORKSPACE_MAPPING.md` - å®Œæ•´è¯´æ˜
- `ID_STRATEGY.md` - ID è®¾è®¡ç­–ç•¥
- `../bridge/example_find_cursor.py` - ä»£ç ç¤ºä¾‹

